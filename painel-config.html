<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Configuração - Portal dos Atletas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="assets/style.css">
</head>

<body class="bg-light">

  <!-- ===== CABEÇALHO DO PAINEL ===== -->
  <header class="portal-header d-flex align-items-center justify-content-between px-4">
    <h1 class="m-0">⚙️ Painel de Administração</h1>
    <a href="index.html" class="btn btn-outline-light btn-sm">
      <i class="bi bi-arrow-left me-1"></i> Voltar
    </a>
  </header>
  <div class="barra-colorida"></div>

  <main class="container my-5">

    <!-- LOGO -->
    <div class="card p-4 mb-4 text-center">
      <h4 class="text-primary fw-bold mb-3">🖼️ Logo do Portal</h4>
      <img id="previewLogo" src="" alt="Logo do Portal" class="img-fluid mb-3" style="max-height:100px; display:none;">
      <input type="file" id="inputLogo" accept="image/*" class="form-control mb-3">
      <button id="btnUploadLogo" class="btn btn-primary">Enviar Logo</button>
    </div>

    <!-- TÍTULO -->
    <div class="card p-4 mb-4">
      <h4 class="text-primary fw-bold mb-3">🏷️ Nome e Descrição do Portal</h4>
      <input type="text" id="portalTitulo" class="form-control mb-2" placeholder="Nome do Portal">
      <input type="text" id="portalSubtitulo" class="form-control mb-3" placeholder="Descrição (ex: Corrida e Bicicleta)">
      <button id="btnSalvarTexto" class="btn btn-primary">Salvar Alterações</button>
    </div>

    <!-- SENHA -->
    <div class="card p-4 mb-4">
      <h4 class="text-primary fw-bold mb-3">🔒 Alterar Senha Administrativa</h4>
      <input type="password" id="senhaAtual" class="form-control mb-2" placeholder="Senha atual">
      <input type="password" id="novaSenha" class="form-control mb-2" placeholder="Nova senha">
      <input type="password" id="confirmarSenha" class="form-control mb-3" placeholder="Confirmar nova senha">
      <button id="btnAlterarSenha" class="btn btn-primary">Alterar Senha</button>
    </div>

  </main>

  <footer>
    © 2025 Energisa Minas Rio — Configurações do Portal
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { app, db } from "./firebase/firebase-config.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const storage = getStorage(app);
    const btnUploadLogo = document.getElementById("btnUploadLogo");
    const inputLogo = document.getElementById("inputLogo");
    const previewLogo = document.getElementById("previewLogo");
    const btnSalvarTexto = document.getElementById("btnSalvarTexto");
    const btnAlterarSenha = document.getElementById("btnAlterarSenha");

    // 🖼️ Upload da logo
    btnUploadLogo.addEventListener("click", async () => {
      const file = inputLogo.files[0];
      if (!file) {
        alert("Selecione uma imagem primeiro!");
        return;
      }

      try {
        const storageRef = ref(storage, `logos/${file.name}`);
        await uploadBytes(storageRef, file);
        const url = await getDownloadURL(storageRef);

        previewLogo.src = url;
        previewLogo.style.display = "block";
        localStorage.setItem("logoPortal", url);

        await setDoc(doc(db, "config", "portal"), { logo: url }, { merge: true });
        alert("Logo atualizada com sucesso!");
      } catch (error) {
        console.error(error);
        alert("Erro ao enviar logo: " + error.message);
      }
    });

    // 🏷️ Salvar título e subtítulo
    btnSalvarTexto.addEventListener("click", async () => {
      const titulo = document.getElementById("portalTitulo").value.trim();
      const subtitulo = document.getElementById("portalSubtitulo").value.trim();

      if (!titulo || !subtitulo) {
        alert("Preencha todos os campos!");
        return;
      }

      localStorage.setItem("portalTitulo", titulo);
      localStorage.setItem("portalSubtitulo", subtitulo);

      await setDoc(doc(db, "config", "portal"), {
        titulo,
        subtitulo
      }, { merge: true });

      alert("Título e descrição salvos com sucesso!");
    });

    // 🔒 Alterar senha
    btnAlterarSenha.addEventListener("click", () => {
      const senhaAtual = document.getElementById("senhaAtual").value.trim();
      const novaSenha = document.getElementById("novaSenha").value.trim();
      const confirmar = document.getElementById("confirmarSenha").value.trim();

      const senhaSalva = localStorage.getItem("senhaAdmin") || "energisa2025";

      if (senhaAtual !== senhaSalva) {
        alert("Senha atual incorreta!");
        return;
      }

      if (novaSenha !== confirmar || novaSenha.length < 5) {
        alert("As senhas não conferem ou são muito curtas!");
        return;
      }

      localStorage.setItem("senhaAdmin", novaSenha);
      alert("Senha alterada com sucesso!");
    });

    // 🔄 Mostrar logo atual
    const logoAtual = localStorage.getItem("logoPortal");
    if (logoAtual) {
      previewLogo.src = logoAtual;
      previewLogo.style.display = "block";
    }
  </script>
</body>
</html>
