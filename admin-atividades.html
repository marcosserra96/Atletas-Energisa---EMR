<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel do Administrador - Atletas Energisa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script type="module" src="firebase/firebase-config.js"></script>
</head>

<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
    <div class="container-fluid justify-content-between">
      <span class="navbar-brand fw-bold">Painel do Administrador</span>
      <a href="index.html" class="btn btn-outline-light btn-sm">Sair</a>
    </div>
  </nav>

  <main class="container my-4">
    <h2 class="text-center text-primary fw-bold mb-4">Atividades Pendentes</h2>

    <div id="lista" class="list-group shadow-sm"></div>

    <div id="vazio" class="text-center text-muted mt-5" style="display:none;">
      <p>Nenhuma atividade pendente até o momento ✅</p>
    </div>
  </main>

  <footer class="text-center py-3 text-muted small">
    © 2025 Energisa Minas Rio — Portal dos Atletas
  </footer>

  <script type="module">
    import { auth, db } from "./firebase/firebase-config.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { collection, query, where, getDocs, updateDoc, doc, getDoc, increment } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const lista = document.getElementById("lista");
    const vazio = document.getElementById("vazio");

    const PONTOS = {
      treino: 10,
      uniforme: 5,
      meta: 20,
      evento: 15
    };

    // Verifica se o usuário é admin
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const userDoc = await getDoc(doc(db, "atletas", user.uid));
      const userData = userDoc.data();

      if (!userData || userData.role !== "admin") {
        alert("Acesso restrito a administradores.");
        window.location.href = "dashboard.html";
        return;
      }

      carregarPendentes();
    });

    async function carregarPendentes() {
      const q = query(collection(db, "atividades"), where("status", "==", "pendente"));
      const snapshot = await getDocs(q);

      lista.innerHTML = "";
      if (snapshot.empty) {
        vazio.style.display = "block";
        return;
      } else {
        vazio.style.display = "none";
      }

      snapshot.forEach(docSnap => {
        const atividade = docSnap.data();
        const id = docSnap.id;

        const item = document.createElement("div");
        item.className = "list-group-item mb-3";
        item.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h6 class="fw-bold mb-1">${atividade.nomeAtleta} <span class="text-muted">(${atividade.equipe})</span></h6>
              <p class="mb-1"><strong>Atividade:</strong> ${atividade.tipo}</p>
              <p class="mb-1"><strong>Data:</strong> ${atividade.data}</p>
              ${atividade.observacao ? `<p class="mb-1"><strong>Obs:</strong> ${atividade.observacao}</p>` : ""}
            </div>
            <div class="d-flex flex-column">
              <button class="btn btn-success btn-sm mb-1" data-id="${id}" data-tipo="${atividade.tipo}" data-atleta="${atividade.atletaId}">Aprovar</button>
              <button class="btn btn-danger btn-sm" data-id="${id}">Rejeitar</button>
            </div>
          </div>
        `;
        lista.appendChild(item);
      });

      // Botões
      lista.querySelectorAll(".btn-success").forEach(btn => {
        btn.addEventListener("click", () => aprovarAtividade(btn.dataset.id, btn.dataset.tipo, btn.dataset.atleta));
      });
      lista.querySelectorAll(".btn-danger").forEach(btn => {
        btn.addEventListener("click", () => rejeitarAtividade(btn.dataset.id));
      });
    }

    async function aprovarAtividade(id, tipo, atletaId) {
      const pontos = PONTOS[tipo] ?? 0;

      // Atualiza atividade
      await updateDoc(doc(db, "atividades", id), {
        status: "aprovada",
        pontos: pontos
      });

      // Soma pontos ao atleta
      await updateDoc(doc(db, "atletas", atletaId), {
        pontosTotais: increment(pontos)
      });

      alert(`Atividade aprovada! +${pontos} pontos adicionados.`);
      carregarPendentes();
    }

    async function rejeitarAtividade(id) {
      await updateDoc(doc(db, "atividades", id), {
        status: "rejeitada"
      });

      alert("Atividade rejeitada.");
      carregarPendentes();
    }
  </script>

</body>
</html>
